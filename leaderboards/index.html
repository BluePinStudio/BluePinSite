<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Game Dev / Publisher Leaderboards</title>
  <link rel="stylesheet" href="leaderboard.css" />

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-5TPPRZVDVF"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-5TPPRZVDVF');
  </script>
</head>

<body>
  <header class="site-header">
    <div class="wrap">
      <h1>Game Dev / Publisher Leaderboards</h1>
      <p class="sub">Ranked by total revenue, median revenue, average revenue, and game count. Uses a year+volume sales-per-review model.</p>
    </div>
  </header>

  <!-- Loader -->
  <div id="loader" class="loader">
    <div class="loader-card">
      <div class="loader-head">
        <strong>Loading games…</strong>
        <span id="loaderPct" class="muted">0%</span>
      </div>
      <div class="bar"><div id="loaderBar" class="bar-fill"></div></div>
      <div id="loaderMeta" class="muted small">0 parsed</div>
      <div class="loader-hint">Streaming JSONL + chunked parsing keeps the UI responsive.</div>
    </div>
  </div>

  <main class="wrap">
    <!-- Tabs -->
    <nav class="tabs" role="tablist" aria-label="Leaderboard entity">
      <button class="tab active" id="tab-devs" role="tab" aria-selected="true" aria-controls="panel-devs" disabled>Developers</button>
      <button class="tab" id="tab-pubs" role="tab" aria-selected="false" aria-controls="panel-pubs" disabled>Publishers</button>
    </nav>

    <!-- Controls -->
    <section class="controls" aria-label="Leaderboard controls">
      <!-- Row A -->
      <div class="row-a">
        <label class="label">Sort by</label>
        <select id="sortBy" class="input">
          <option value="total" selected>Total revenue</option>
          <option value="median">Median revenue</option>
          <option value="avg">Average revenue</option>
          <option value="count">Game count</option>
        </select>

        <button id="orderBtn" class="btn" title="Toggle sort order">↓ Desc</button>

        <label class="label">Min games</label>
        <input id="minCount" type="number" class="input" min="1" step="1" placeholder="1" />

        <div class="checks-inline">
          <label class="check"><input id="ignoreFree" type="checkbox" /> <span>Ignore free games</span></label>
          <label class="check"><input id="ignoreComingSoon" type="checkbox" checked /> <span>Ignore coming soon</span></label>
        </div>
      </div>

      <!-- Row C: Compare list (chips + autocomplete) -->
      <div class="row-c">
        <div id="compareBox" class="chipbox">

          <input id="chipInput" type="text" class="chip-input" placeholder="Type a developer/publisher and press Enter…" autocomplete="off" />
          <ul id="chipList" class="chips"></ul>
          <div id="acList" class="ac-list" hidden></div>
        </div>
        <label class="check"><input id="enableCompare" type="checkbox" /> <span>Compare list only</span></label>
        <label class="check"><input id="relativeRank" type="checkbox" checked /> <span>Show relative ranks</span></label>
      </div>

      <small class="meta">
        Revenue model: <code>rev = max(reviews − 10, 0) × spr(year, volume) × price</code>.
      </small>
    </section>

    <!-- Developers -->
    <section id="panel-devs" class="panel" role="tabpanel" aria-labelledby="tab-devs">
      <div id="devSummary" class="summary"></div>
      <div class="table-wrap">
        <table class="table" id="devTable" aria-label="Developers leaderboard">
          <thead>
            <tr>
              <th>#</th>
              <th>Developer</th>
              <th class="num">Games</th>
              <th class="num">Total</th>
              <th class="num">Median</th>
              <th class="num">Average</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="pager">
        <div class="pager-left">
          <label class="label">Rows per page</label>
          <select id="devPageSize" class="input pager-size">
            <option>25</option>
            <option selected>50</option>
            <option>100</option>
            <option>250</option>
          </select>
          <span id="devRange" class="meta"></span>
        </div>
        <div class="pager-right">
          <button id="devPrev" class="btn" disabled>← Prev</button>
          <span id="devPageMeta" class="meta"></span>
          <button id="devNext" class="btn" disabled>Next →</button>
        </div>
      </div>
    </section>

    <!-- Publishers -->
    <section id="panel-pubs" class="panel hidden" role="tabpanel" aria-labelledby="tab-pubs">
      <div id="pubSummary" class="summary"></div>
      <div class="table-wrap">
        <table class="table" id="pubTable" aria-label="Publishers leaderboard">
          <thead>
            <tr>
              <th>#</th>
              <th>Publisher</th>
              <th class="num">Games</th>
              <th class="num">Total</th>
              <th class="num">Median</th>
              <th class="num">Average</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="pager">
        <div class="pager-left">
          <label class="label">Rows per page</label>
          <select id="pubPageSize" class="input pager-size">
            <option>25</option>
            <option selected>50</option>
            <option>100</option>
            <option>250</option>
          </select>
          <span id="pubRange" class="meta"></span>
        </div>
        <div class="pager-right">
          <button id="pubPrev" class="btn" disabled>← Prev</button>
          <span id="pubPageMeta" class="meta"></span>
          <button id="pubNext" class="btn" disabled>Next →</button>
        </div>
      </div>
    </section>

    <!-- Details Drawer -->
    <dialog id="orgDialog" class="org-drawer">
      <div class="org-head">
        <div>
          <h3 id="orgTitle">Org</h3>
          <div id="orgMeta" class="org-meta"></div>
        </div>
        <button class="org-close" id="orgClose">Close</button>
      </div>
      <div class="org-body">
        <div id="gamesList" class="games-grid"></div>
      </div>
    </dialog>
  </main>

  <script>
    // ---------------- Config ----------------
    const JSON_LINES_PATH = 'games.jsonl';
    const CURRENCY = 'USD';

    // ---------------- Utilities ----------------
    const fmtUSD = n => (Number.isFinite(n) ? n.toLocaleString(undefined, { style: 'currency', currency: CURRENCY, maximumFractionDigits: 0 }) : '—');
    const fmtInt = n => (Number.isFinite(n) ? n.toLocaleString() : '—');
    const arr = v => Array.isArray(v) ? v : (v ? [v] : []);
    const norm = s => String(s ?? '').trim();
    const idle = () => new Promise(r => setTimeout(r, 0));
    const fmtMonYear = ts => ts ? new Date(ts).toLocaleString(undefined, { month: 'short', year: 'numeric' }) : '—';

    const isFiniteNum = v => Number.isFinite(v);
    const toPosNum = v => { const n = Number(v); return Number.isFinite(n) && n > 0 ? n : null; };

    // Kahan summation
    function sumStable(values) {
      let sum = 0, c = 0;
      for (let i = 0; i < values.length; i++) {
        const y = values[i] - c;
        const t = sum + y;
        c = (t - sum) - y;
        sum = t;
      }
      return sum;
    }
    function arrayMedian(values) {
      if (!values || !values.length) return NaN;
      const a = values.slice().sort((x, y) => x - y);
      const m = Math.floor(a.length / 2);
      return a.length % 2 ? a[m] : (a[m - 1] + a[m]) / 2;
    }
    function parseReleaseTs(raw) {
      if (!raw) return null;
      if (raw === 'Coming soon') return null;
      if (typeof raw === 'number') return raw < 1e12 ? raw * 1000 : raw;
      const t = Date.parse(raw);
      if (!Number.isNaN(t)) return t;
      const m = String(raw).match(/^(\d{4})(?:-(\d{2}))?/);
      if (m) { const y = +m[1], mo = m[2] ? (+m[2] - 1) : 0; return Date.UTC(y, mo, 1); }
      return null;
    }

    // Year + review-volume SPR
    function salesPerReviewMultiple(year, reviewCount) {
      const y = year || new Date().getFullYear(); let base;
      if (y <= 2016) base = 74;
      else if (y <= 2018) base = 60;
      else if (y === 2019) base = 51;
      else if (y === 2020) base = 38;
      else if (y === 2021) base = 36;
      else if (y === 2022) base = 35;
      else base = 33;
      if (reviewCount != null) {
        if (reviewCount < 100) base = Math.min(base, 36);
        else if (reviewCount >= 1000 && reviewCount < 10000) base = Math.max(base, 52.8);
        else if (reviewCount >= 10000) base = Math.max(base, 60);
      }
      return base;
    }

// Hardened revenue with tiered early-review deduction
function revenueUSD(game, { ignoreFree = false } = {}) {
  const reviewsRaw = toPosNum(game.review_count);
  const rawPrice = Number(game.price_usd);
  const isFree = game.is_free === true || rawPrice === 0;

  if (ignoreFree && isFree) return null;
  if (!reviewsRaw) return null;

  const price = isFree ? 0 : toPosNum(rawPrice);
  if (!isFree && !price) return null;

  // Tiered deduction:
  // 5–10: −3, 10–20: −6, 20–30: −9, >30: −12
  const r = reviewsRaw;
  let deduct = 0;
  if (r >= 5 && r <= 10) deduct = 3;
  else if (r > 10 && r <= 20) deduct = 6;
  else if (r > 20 && r <= 30) deduct = 9;
  else if (r > 30) deduct = 12;

  const effectiveReviews = Math.max(0, r - deduct);

  const year = game.release_year ?? null;
  // keep SPR logic "as is" (based on original review count + year)
  const spr = salesPerReviewMultiple(year, r);
  const rev = effectiveReviews * spr * (price || 0);

  return Number.isFinite(rev) && rev >= 0 ? rev : null;
}


    // ---------------- State & DOM ----------------
    const tabDevs = document.getElementById('tab-devs');
    const tabPubs = document.getElementById('tab-pubs');
    const panelDevs = document.getElementById('panel-devs');
    const panelPubs = document.getElementById('panel-pubs');

    const sortByEl = document.getElementById('sortBy');
    const orderBtn = document.getElementById('orderBtn');
    const minCountEl = document.getElementById('minCount');

    const ignoreFreeEl = document.getElementById('ignoreFree');
    const ignoreComingSoonEl = document.getElementById('ignoreComingSoon');

    const enableCompareEl = document.getElementById('enableCompare');
    const relativeRankEl = document.getElementById('relativeRank');

    const devTableBody = document.querySelector('#devTable tbody');
    const pubTableBody = document.querySelector('#pubTable tbody');
    const devSummary = document.getElementById('devSummary');
    const pubSummary = document.getElementById('pubSummary');

    const devPageSizeEl = document.getElementById('devPageSize');
    const devPrev = document.getElementById('devPrev');
    const devNext = document.getElementById('devNext');
    const devPageMeta = document.getElementById('devPageMeta');
    const devRange = document.getElementById('devRange');

    const pubPageSizeEl = document.getElementById('pubPageSize');
    const pubPrev = document.getElementById('pubPrev');
    const pubNext = document.getElementById('pubNext');
    const pubPageMeta = document.getElementById('pubPageMeta');
    const pubRange = document.getElementById('pubRange');

    const loader = document.getElementById('loader');
    const loaderBar = document.getElementById('loaderBar');
    const loaderPct = document.getElementById('loaderPct');
    const loaderMeta = document.getElementById('loaderMeta');

    // Drawer DOM
    const orgDialog = document.getElementById('orgDialog');
    const orgTitle = document.getElementById('orgTitle');
    const orgMeta = document.getElementById('orgMeta');
    const orgClose = document.getElementById('orgClose');
    const gamesList = document.getElementById('gamesList');

    // Chip/autocomplete DOM
    const compareBox = document.getElementById('compareBox');
    const chipList = document.getElementById('chipList');
    const chipInput = document.getElementById('chipInput');
    const acList = document.getElementById('acList');

    let RAW_MIN = [];
    let currentTab = 'devs';
    let desc = true;

    // memoized views
    let memoDevs = [];
    let memoPubs = [];

    // complete, globally ranked rows (per tab)
    let allDevs = [];
    let allPubs = [];

    // pagination state
    const pager = {
      dev: { page: 1, size: 50 },
      pub: { page: 1, size: 50 }
    };

    // Compare chips state
    let compareNames = [];

    function setTab(which) {
      currentTab = which;
      if (which === 'devs') {
        tabDevs.classList.add('active'); tabDevs.setAttribute('aria-selected', 'true');
        tabPubs.classList.remove('active'); tabPubs.setAttribute('aria-selected', 'false');
        panelDevs.classList.remove('hidden'); panelPubs.classList.add('hidden');
        renderDevPage();
      } else {
        tabPubs.classList.add('active'); tabPubs.setAttribute('aria-selected', 'true');
        tabDevs.classList.remove('active'); tabDevs.setAttribute('aria-selected', 'false');
        panelPubs.classList.remove('hidden'); panelDevs.classList.add('hidden');
        renderPubPage();
      }
      clearAutocomplete();
    }

    tabDevs.addEventListener('click', () => setTab('devs'));
    tabPubs.addEventListener('click', () => setTab('pubs'));

    sortByEl.addEventListener('change', rebuildViews);
    orderBtn.addEventListener('click', () => { desc = !desc; orderBtn.textContent = desc ? '↓ Desc' : '↑ Asc'; rebuildViews(); });
    minCountEl.addEventListener('input', debounce(rebuildViews, 120));
    [ignoreFreeEl, ignoreComingSoonEl].forEach(el => el.addEventListener('change', () => { rebuildViews(); if (orgDialog.open) refreshOpenDrawer(); }));

enableCompareEl.addEventListener('change', () => {
  rebuildViews();       // ensures relRank is computed or cleared properly
});

    relativeRankEl.addEventListener('change', () => {
      if (currentTab === 'devs') renderDevPage(); else renderPubPage();
    });

    devPageSizeEl.addEventListener('change', () => { pager.dev.size = +devPageSizeEl.value; pager.dev.page = 1; renderDevPage(); });
    devPrev.addEventListener('click', () => { if (pager.dev.page > 1) { pager.dev.page--; renderDevPage(); } });
    devNext.addEventListener('click', () => { const pages = Math.max(1, Math.ceil(memoDevs.length / pager.dev.size)); if (pager.dev.page < pages) { pager.dev.page++; renderDevPage(); } });

    pubPageSizeEl.addEventListener('change', () => { pager.pub.size = +pubPageSizeEl.value; pager.pub.page = 1; renderPubPage(); });
    pubPrev.addEventListener('click', () => { if (pager.pub.page > 1) { pager.pub.page--; renderPubPage(); } });
    pubNext.addEventListener('click', () => { const pages = Math.max(1, Math.ceil(memoPubs.length / pager.pub.size)); if (pager.pub.page < pages) { pager.pub.page++; renderPubPage(); } });

    function debounce(fn, ms) { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); }; }

    // ----- core compute
    function applyFilters(rows, minCount) {
      return rows.filter(r => (minCount ? r.count >= minCount : true));
    }

    function sortRows(rows, by, descFlag) {
      const key = { total: 'total', median: 'median', avg: 'avg', count: 'count' }[by] || 'total';
      rows.sort((a, b) => {
        const d = (b[key] - a[key]) || (b.total - a.total) || (b.count - a.count) || a.name.localeCompare(b.name);
        return descFlag ? d : -d;
      });
      return rows;
    }

    function collectOrgStats(role) {
      const ignoreComingSoon = !!ignoreComingSoonEl.checked;
      const ignoreFree = !!ignoreFreeEl.checked;

      const map = new Map(); // name -> { name, revs: [] }

      for (const g of RAW_MIN) {
        if (ignoreComingSoon && g.coming_soon) continue;

        const names = Array.isArray(g[role]) ? g[role] : (g[role] ? [g[role]] : []);
        if (!names.length) continue;

        const rev = revenueUSD(g, { ignoreFree });
        if (rev === null) continue;

        for (const raw of names) {
          const name = norm(raw);
          if (!name) continue;
          if (!map.has(name)) map.set(name, { name, revs: [] });
          map.get(name).revs.push(rev);
        }
      }

      const rows = [];
      for (const { name, revs } of map.values()) {
        if (!revs.length) continue;
        const total = sumStable(revs);
        const count = revs.length;
        const avg = total / count;
        const med = arrayMedian(revs);
        rows.push({ name, total, median: med, avg, count });
      }
      return rows;
    }

    function summarize(rows) {
      const total = rows.reduce((a, r) => a + r.total, 0);
      const games = rows.reduce((a, r) => a + r.count, 0);
      return { orgs: rows.length, games, total };
    }

    // ---- Compare (chips) helpers
    function parseCompareSet() {
      const set = new Set(compareNames.map(s => s.toLowerCase()));
      return { set, original: compareNames.slice() };
    }

    function annotateGlobalRank(rows) {
      rows.forEach((r, i) => r.globalRank = i + 1);
      return rows;
    }

    // ----- render (paginated)
    function renderPage(tbody, rows, page, size, opts) {
      const { compareOn, relativeRanks, role } = opts || { compareOn: false, relativeRanks: false, role: 'developers' };
      tbody.innerHTML = '';
      const start = (page - 1) * size;
      const end = Math.min(rows.length, start + size);
      const frag = document.createDocumentFragment();
      for (let i = start; i < end; i++) {
        const r = rows[i];
const displayRank = compareOn
  ? (relativeRanks && r.relRank != null ? r.relRank : (r.globalRank ?? (i + 1)))
  : (i + 1);

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="rank">${displayRank}</td>
          <td class="name">
            <span class="org-name">${r.name}</span>
            <button class="org-open-btn" data-role="${role}" data-name="${r.name}" aria-label="View games for ${r.name}" title="View games">🔎</button>
          </td>
          <td class="num">${r.count.toLocaleString()}</td>
          <td class="num strong">${fmtUSD(r.total)}</td>
          <td class="num">${fmtUSD(r.median)}</td>
          <td class="num">${fmtUSD(r.avg)}</td>
        `;
        frag.appendChild(tr);
      }
      tbody.appendChild(frag);
      return { start: start + 1, end, total: rows.length };
    }

    function renderDevPage() {
      const { page, size } = pager.dev;
      const compareOn = enableCompareEl.checked && (compareNames.length > 0);
      const { start, end, total } = renderPage(devTableBody, memoDevs, page, size, { compareOn, relativeRanks: !!relativeRankEl.checked, role: 'developers' });
      const pages = Math.max(1, Math.ceil(memoDevs.length / size));
      devPrev.disabled = page <= 1;
      devNext.disabled = page >= pages;
      devPageMeta.textContent = `Page ${page} / ${pages}`;
      devRange.textContent = total ? `Showing ${start}–${end} of ${fmtInt(total)}` : '';
      const s = summarize(memoDevs);
      const base = `${fmtInt(s.orgs)} developers • ${fmtInt(s.games)} games • ${fmtUSD(s.total)} total`;
      devSummary.textContent = base + (compareOn ? ' • Compare mode' : '');
    }
    function renderPubPage() {
      const { page, size } = pager.pub;
      const compareOn = enableCompareEl.checked && (compareNames.length > 0);
      const { start, end, total } = renderPage(pubTableBody, memoPubs, page, size, { compareOn, relativeRanks: !!relativeRankEl.checked, role: 'publishers' });
      const pages = Math.max(1, Math.ceil(memoPubs.length / size));
      pubPrev.disabled = page <= 1;
      pubNext.disabled = page >= pages;
      pubPageMeta.textContent = `Page ${page} / ${pages}`;
      pubRange.textContent = total ? `Showing ${start}–${end} of ${fmtInt(total)}` : '';
      const s = summarize(memoPubs);
      const base = `${fmtInt(s.orgs)} publishers • ${fmtInt(s.games)} games • ${fmtUSD(s.total)} total`;
      pubSummary.textContent = base + (compareOn ? ' • Compare mode' : '');
    }

    function rebuildViews() {
      const by = sortByEl.value;
      const minCount = Number(minCountEl.value || 0);
      const { set: cmpSet } = parseCompareSet();
      const compareOn = enableCompareEl.checked && cmpSet.size > 0;

      // Build ALL rows (no minCount yet), sort, annotate global rank
      allDevs = annotateGlobalRank(sortRows(collectOrgStats('developers'), by, desc));
      allPubs = annotateGlobalRank(sortRows(collectOrgStats('publishers'), by, desc));

// Regular filtering vs compare
let devRows = allDevs;
let pubRows = allPubs;

if (enableCompareEl.checked && cmpSet.size === 0) {
  // User wants compare-only but list is empty → show nothing
  devRows = [];
  pubRows = [];
} else if (compareOn) {
  const hasName = r => cmpSet.has(r.name.toLowerCase());
  devRows = allDevs.filter(hasName);
  pubRows = allPubs.filter(hasName);
  devRows.forEach((r, i) => r.relRank = i + 1);
  pubRows.forEach((r, i) => r.relRank = i + 1);
} else {
  devRows = applyFilters(allDevs, minCount);
  pubRows = applyFilters(allPubs, minCount);
  devRows.forEach(r => r.relRank = undefined);
  pubRows.forEach(r => r.relRank = undefined);
}


      memoDevs = devRows;
      memoPubs = pubRows;
      pager.dev.page = 1; pager.pub.page = 1;

      if (currentTab === 'devs') { renderDevPage(); } else { renderPubPage(); }
    }

    // ---------------- Streaming JSONL loader with progress ----------------
    async function loadJSONLStream(url) {
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`Failed to load ${url} (HTTP ${res.status})`);

      const contentLen = +res.headers.get('content-length') || 0;
      const reader = res.body?.getReader?.();
      if (!reader) {
        const text = await res.text();
        await parseTextInChunks(text, contentLen || text.length);
        return;
      }

      const decoder = new TextDecoder();
      let received = 0, buffer = '', parsedCount = 0;

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        received += value.byteLength;
        buffer += decoder.decode(value, { stream: true });

        let lines = buffer.split(/\r?\n/);
        buffer = lines.pop() ?? '';

        for (let i = 0; i < lines.length; i++) {
          const raw = lines[i].trim(); if (!raw) continue;
          try { pushMinimal(JSON.parse(raw)); parsedCount++; } catch { }
          if (parsedCount % 2000 === 0) { updateLoader(received, contentLen, parsedCount); await idle(); }
        }
        updateLoader(received, contentLen, parsedCount);
      }

      if (buffer.trim()) { try { pushMinimal(JSON.parse(buffer.trim())); parsedCount++; } catch { } }
      updateLoader(contentLen || 1, contentLen || 1, parsedCount);
    }

    async function parseTextInChunks(text, totalBytes) {
      const lines = text.split(/\r?\n/); let parsed = 0;
      for (let i = 0; i < lines.length; i++) {
        const raw = lines[i].trim(); if (!raw) continue;
        try { pushMinimal(JSON.parse(raw)); parsed++; } catch { }
        if (i % 2000 === 0) { updateLoader(i, lines.length, parsed); await idle(); }
      }
      updateLoader(lines.length, lines.length, parsed);
    }

    function pushMinimal(j) {
      const id = j.identity || {}, rel = j.release || {}, pricing = j.pricing || {}, reviews = j.reviews || {}, media = j.media || {};
      const ts = parseReleaseTs(rel.date_iso ?? rel.date_raw);
      RAW_MIN.push({
        app_id: j.app_id,
        name: id.name || `App ${j.app_id}`,
        header_image: media.header_image || null,
        developers: arr(id.developers),
        publishers: arr(id.publishers),
        price_usd: pricing.price_usd ?? null,
        is_free: !!pricing.is_free,
        review_count: (reviews.review_count) ?? (reviews.total_reviews) ?? 0,
        release_ts: ts,
        release_year: ts ? new Date(ts).getFullYear() : null,
        coming_soon: !!rel.coming_soon
      });
    }

    function updateLoader(received, total, parsedCount) {
      const pct = total ? Math.min(100, Math.round((received / total) * 100)) : (parsedCount ? 100 : 0);
      loaderBar.style.width = (pct || 0) + '%';
      loaderPct.textContent = pct + '%';
      loaderMeta.textContent = `${fmtInt(parsedCount)} parsed`;
    }
    function hideLoader() {
      loader.classList.add('hide');
      setTimeout(() => {
        loader.remove();
        tabDevs.disabled = false; tabPubs.disabled = false;
      }, 350);
    }

    // --------- Org details drawer ---------
    function openOrgDetails(role, name) {
      const ignoreComingSoon = !!ignoreComingSoonEl.checked;
      const ignoreFree = !!ignoreFreeEl.checked;

      const games = RAW_MIN.filter(g => {
        if (ignoreComingSoon && g.coming_soon) return false;
        const pool = (role === 'developers') ? g.developers : g.publishers;
        return (pool || []).some(n => norm(n).toLowerCase() === norm(name).toLowerCase());
      }).map(g => {
        const rev = revenueUSD(g, { ignoreFree });
        return { g, rev };
      }).filter(x => x.rev !== null);

      games.sort((a, b) => (b.rev - a.rev) || ((b.g.review_count || 0) - (a.g.review_count || 0)));

      const total = sumStable(games.map(x => x.rev));
      const count = games.length;

      orgTitle.textContent = `${name} — ${role === 'developers' ? 'Developer' : 'Publisher'}`;
      orgMeta.textContent = `${fmtInt(count)} games • ${fmtUSD(total)} total (current settings)`;

      gamesList.innerHTML = '';
      const frag = document.createDocumentFragment();
      for (const { g, rev } of games) {
        const card = document.createElement('div');
        card.className = 'gcard';
        const left = document.createElement('div');
        if (g.header_image) {
          const img = document.createElement('img');
          img.className = 'gthumb';
          img.loading = 'lazy'; img.decoding = 'async';
          img.alt = `${g.name} header`; img.src = g.header_image || '';
          left.appendChild(img);
        }
        const right = document.createElement('div');
        right.innerHTML = `
          <h4 class="gtitle"><a href="https://store.steampowered.com/app/${g.app_id}" target="_blank" rel="noopener noreferrer">${g.name}</a></h4>
          <div class="gmeta">
            <span class="pill">${g.coming_soon ? 'Coming soon' : (g.release_ts ? fmtMonYear(g.release_ts) : '—')}</span>
            <span class="pill">Reviews: <span class="num">${fmtInt(g.review_count)}</span></span>
            <span class="pill">Price: ${g.is_free || g.price_usd === 0 ? 'Free' : (g.price_usd == null ? '—' : ('$' + Number(g.price_usd).toFixed(2)))}</span>
          </div>
          <div class="gnums">
            <span><strong>Estimated revenue:</strong> ${fmtUSD(rev)}</span>
          </div>
        `;
        card.appendChild(left); card.appendChild(right);
        frag.appendChild(card);
      }
      gamesList.appendChild(frag);

      if (typeof orgDialog.showModal === 'function') orgDialog.showModal();
      else orgDialog.setAttribute('open', '');
    }

    function refreshOpenDrawer() {
      const head = orgTitle.textContent || '';
      const m = head.match(/^(.*)\s—\s(Developer|Publisher)$/);
      if (!m) return;
      const name = m[1]; const role = (m[2] === 'Developer') ? 'developers' : 'publishers';
      openOrgDetails(role, name);
    }

    orgClose.addEventListener('click', () => orgDialog.close());
    orgDialog.addEventListener('click', (e) => {
      const rect = orgDialog.getBoundingClientRect();
      if (e.clientX < rect.left || e.clientX > rect.right || e.clientY < rect.top || e.clientY > rect.bottom) {
        orgDialog.close();
      }
    });
    document.addEventListener('keydown', e => { if (e.key === 'Escape' && orgDialog.open) orgDialog.close(); });

    // delegate clicks on the small "open" button (Alt+Click to add chip)
    function handleOrgButton(e) {
      const btn = e.target.closest('.org-open-btn');
      if (!btn) return;
      const role = btn.dataset.role;
      const name = btn.dataset.name;
      if (e.altKey) {
        addChip(name);
      } else {
        openOrgDetails(role, name);
      }
    }
    devTableBody.addEventListener('click', handleOrgButton);
    pubTableBody.addEventListener('click', handleOrgButton);

    // ---------- Chips + Autocomplete ----------
    function renderChips() {
      chipList.innerHTML = '';
      const frag = document.createDocumentFragment();
      for (const name of compareNames) {
        const li = document.createElement('li');
        li.className = 'chip';
        li.innerHTML = `
          <span class="chip-text">${name}</span>
          <button class="chip-remove" aria-label="Remove ${name}" title="Remove">×</button>
        `;
        li.querySelector('.chip-remove').addEventListener('click', () => {
          removeChip(name);
        });
        frag.appendChild(li);
      }
      chipList.appendChild(frag);
    }

    function getCurrentPoolNames() {
      const rows = (currentTab === 'devs') ? allDevs : allPubs;
      return rows.map(r => r.name);
    }

    function getCanonicalOrgName(raw) {
      const q = norm(raw).toLowerCase();
      if (!q) return null;
      const pool = getCurrentPoolNames();
      const exact = pool.find(n => n.toLowerCase() === q);
      if (exact) return exact;
      return norm(raw);
    }

    function addChip(name) {
      const canonical = getCanonicalOrgName(name);
      if (!canonical) return;
      const has = compareNames.some(n => n.toLowerCase() === canonical.toLowerCase());
      if (!has) {
        compareNames.push(canonical);
        renderChips();
        rebuildViews();
      }
    }

    function removeChip(name) {
      compareNames = compareNames.filter(n => n.toLowerCase() !== name.toLowerCase());
      renderChips();
      rebuildViews();
    }

    function clearAutocomplete() {
      acList.innerHTML = '';
      acList.hidden = true;
    }

    function fuzzySuggest(query, pool, max = 8) {
      const q = norm(query).toLowerCase();
      if (!q) return [];
      const scored = [];
      for (const name of pool) {
        const n = name.toLowerCase();
        const idx = n.indexOf(q);
        if (idx === -1) continue;
        const starts = n.startsWith(q) ? 0 : 1;
        scored.push({ name, score: starts * 100 + idx });
      }
      scored.sort((a, b) => a.score - b.score || a.name.localeCompare(b.name));
      return scored.slice(0, max).map(s => s.name);
    }

    function renderAutocomplete(list) {
      if (!list.length) { clearAutocomplete(); return; }
      acList.innerHTML = '';
      const frag = document.createDocumentFragment();
      list.forEach((name, i) => {
        const div = document.createElement('div');
        div.className = 'ac-item';
        div.setAttribute('role', 'option');
        if (i === 0) div.setAttribute('aria-selected', 'true');
        div.textContent = name;
        div.addEventListener('mousedown', (e) => {
          e.preventDefault();
          addChip(name);
          chipInput.value = '';
          clearAutocomplete();
          chipInput.focus();
        });
        frag.appendChild(div);
      });
      acList.appendChild(frag);
      acList.hidden = false;
    }

    const updateAutocomplete = debounce(() => {
      const q = chipInput.value;
      if (!q) { clearAutocomplete(); return; }
      const pool = getCurrentPoolNames();
      const suggestions = fuzzySuggest(q, pool);
      renderAutocomplete(suggestions);
    }, 80);

    compareBox.addEventListener('click', () => chipInput.focus());
    chipInput.addEventListener('input', () => updateAutocomplete());

    chipInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const first = acList.querySelector('.ac-item');
        if (first) {
          addChip(first.textContent);
        } else {
          addChip(chipInput.value);
        }
        chipInput.value = '';
        clearAutocomplete();
      } else if (e.key === 'Backspace' && !chipInput.value) {
        const last = compareNames[compareNames.length - 1];
        if (last) removeChip(last);
      } else if ((e.key === 'ArrowDown' || e.key === 'ArrowUp') && !acList.hidden) {
        e.preventDefault();
        const items = Array.from(acList.querySelectorAll('.ac-item'));
        if (!items.length) return;
        let idx = items.findIndex(it => it.getAttribute('aria-selected') === 'true');
        if (idx < 0) idx = 0;
        items[idx].removeAttribute('aria-selected');
        idx = e.key === 'ArrowDown' ? Math.min(idx + 1, items.length - 1) : Math.max(idx - 1, 0);
        items[idx].setAttribute('aria-selected', 'true');
        items[idx].scrollIntoView({ block: 'nearest' });
      }
    });

    chipInput.addEventListener('blur', () => setTimeout(clearAutocomplete, 120));

    // Paste: split by newline/tab only (NOT commas—commas inside names are preserved)
    chipInput.addEventListener('paste', (e) => {
      const txt = (e.clipboardData || window.clipboardData).getData('text');
      if (!txt) return;
      const parts = txt.split(/[\n\t]+/).map(s => norm(s)).filter(Boolean);
      if (parts.length > 1) {
        e.preventDefault();
        parts.forEach(addChip);
        chipInput.value = '';
        clearAutocomplete();
      }
    });

    // ---------------- Init ----------------
    (async () => {
      try {
        await loadJSONLStream(JSON_LINES_PATH);
      } catch (err) {
        console.warn(err);
        // tiny fallback
        RAW_MIN = [
          { app_id: 1, name: 'Alpha', header_image: null, developers: ['Studio One'], publishers: ['Pub X'], price_usd: 19.99, is_free: false, review_count: 1200, release_ts: Date.parse('2022-05-01'), release_year: 2022, coming_soon: false },
          { app_id: 2, name: 'Beta', header_image: null, developers: ['Studio One', 'Studio Two'], publishers: ['Pub Y'], price_usd: 9.99, is_free: false, review_count: 300, release_ts: Date.parse('2021-11-13'), release_year: 2021, coming_soon: false },
          { app_id: 3, name: 'Gamma', header_image: null, developers: ['Studio Two'], publishers: ['Pub X'], price_usd: 0, is_free: true, review_count: 5000, release_ts: Date.parse('2023-08-18'), release_year: 2023, coming_soon: false },
          { app_id: 4, name: 'Delta', header_image: null, developers: ['Solo Dev'], publishers: ['Pub Z'], price_usd: 14.99, is_free: false, review_count: 50, release_ts: null, release_year: null, coming_soon: true }
        ];
      } finally {
        hideLoader();
        rebuildViews();
        setTab('devs');
        renderChips();
      }
    })();
  </script>
</body>
</html>
