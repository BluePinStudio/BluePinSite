<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Steam Gumball Machine</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="site-header">
    <h1 class="logo">Steam Gumball Machine <span class="sparkle">✨</span></h1>
    <p class="sub">Randomize a Steam game with filters. The ball is a real circle (no scrollbars) — content scales to fit.</p>
  </header>

  <main class="layout">
    <!-- FILTERS -->
    <aside class="panel" id="filters">
      <h2 class="panel-title">Filters</h2>

      <div class="field">
        <label for="q">Search (name contains)</label>
        <input id="q" class="input" type="text" placeholder="e.g., puzzle, rogue..." />
      </div>

      <div class="field">
        <label>Price range (USD)</label>
        <div class="row">
          <input id="priceMin" class="input" type="number" min="0" step="0.01" placeholder="Min" />
          <input id="priceMax" class="input" type="number" min="0" step="0.01" placeholder="Max" />
        </div>
        <div class="meta">Free games are included if they fall in range (0 qualifies).</div>
      </div>

      <div class="field">
        <label for="dateMin">Exclude games before</label>
        <input id="dateMin" class="input" type="date" />
        <div class="field-inline" style="margin-top:.5rem">
          <input id="hideUnreleased" type="checkbox" />
          <label for="hideUnreleased" style="margin:0">Hide unreleased (Coming soon)</label>
        </div>
      </div>

      <div class="divider"></div>

      <div class="actions">
        <button class="btn" id="apply">Apply</button>
        <button class="btn btn-ghost" id="clear">Clear</button>
      </div>
    </aside>

    <!-- MACHINE -->
    <section class="stage">
      <section class="machine">
        <div class="bowl">
          <div class="gumballs" aria-hidden="true"></div>
        </div>

        <div class="machine-mid">
          <button class="coin-slot btn" id="btnLoad">Load</button>
          <button class="crank btn" id="btnRoll" disabled>Dispense</button>
        </div>

        <div class="chute">
          <!-- PERFECT CIRCLE GUMBALL -->
          <div class="ball" id="ball" style="--cap:#ff66c4">
            <div class="cap-top"></div>
            <div class="ball-body">
              <!-- Scaled card goes here -->
            </div>
          </div>
        </div>
      </section>

      <p class="results-meta" id="resultsMeta" aria-live="polite"></p>
    </section>
  </main>

  <footer class="site-footer">
    <small>Made with ❤️ — Capsule images belong to their respective owners on Steam.</small>
  </footer>

  <script>
  // ---------------- Utilities ----------------
  const $ = sel => document.querySelector(sel);
  const rand = (a,b)=>Math.random()*(b-a)+a;
  const pick = arr => arr[Math.floor(Math.random()*arr.length)];
  const clampNum = (v,min,max)=>Math.min(max,Math.max(min,v));

  function randomCapColor() {
    // Warm/violet/pink hues (avoid cyan/Steam-blue)
    const hues = [350, 6, 12, 18, 24, 30, 280, 300, 318];
    const h = pick(hues);
    return `hsl(${h} 88% 58%)`;
  }
  function applyCapColor(ballEl){
    ballEl.style.setProperty('--cap', randomCapColor());
  }

  function toISO(d) {
    if (!d) return null;
    const t = Date.parse(d);
    return isNaN(t) ? null : new Date(t).toISOString().slice(0,10);
  }

  function getFilters(){
    const q = $('#q').value.trim().toLowerCase();
    const priceMin = parseFloat($('#priceMin').value);
    const priceMax = parseFloat($('#priceMax').value);
    const dateMin = $('#dateMin').value ? toISO($('#dateMin').value) : null;
    const hideUnreleased = $('#hideUnreleased').checked;
    return { q, priceMin: isNaN(priceMin)?null:priceMin, priceMax: isNaN(priceMax)?null:priceMax, dateMin, hideUnreleased };
  }

  function gameMatches(g, f){
    // name query
    if (f.q) {
      const name = (g?.identity?.name || '').toLowerCase();
      if (!name.includes(f.q)) return false;
    }
    // price range
    const isFree = !!g?.pricing?.is_free;
    const price = isFree ? 0 : (typeof g?.pricing?.price_usd === 'number' ? g.pricing.price_usd : null);
    if (f.priceMin!=null && (price==null || price < f.priceMin)) return false;
    if (f.priceMax!=null && (price==null || price > f.priceMax)) return false;

    // date filter
    const comingSoon = !!g?.release?.coming_soon;
    if (f.hideUnreleased && comingSoon) return false;

    if (f.dateMin){
      const iso = g?.release?.date_iso || null;
      if (!iso) return false; // treat unknown as excluded if strict
      if (iso < f.dateMin) return false;
    }
    return true;
  }

  function filterGames(list, f){
    return list.filter(g => gameMatches(g, f));
  }

  // Scale the single .result-card to fit under the cap inside the circle
  function layoutBall(ballEl){
    if(!ballEl) return;
    const body = ballEl.querySelector('.ball-body');
    const card = body && body.querySelector('.result-card');
    if(!body || !card) return;

    // reset scale to measure natural size
    card.style.transform = 'scale(1)';
    const bodyRect = body.getBoundingClientRect();
    const cardRect = card.getBoundingClientRect();

    // leave a tiny breathing room so edges never clip
    const scale = Math.min(
      (bodyRect.width  - 6) / cardRect.width,
      (bodyRect.height - 6) / cardRect.height,
      1
    );

    card.style.transform = `scale(${scale})`;
  }

  // Build top-bowl marbles from random games' header images
  function buildBowlMarbles(allGames){
    const wrap = document.querySelector('.gumballs');
    if(!wrap || !allGames?.length) return;
    wrap.innerHTML = '';

    const pool = allGames.filter(g => g?.media?.header_image);
    const pickCount = Math.min(20, pool.length);
    const chosen = [];
    while (chosen.length < pickCount && pool.length) {
      chosen.push(pool.splice(Math.floor(Math.random()*pool.length),1)[0]);
    }

    chosen.forEach(g => {
      const m = document.createElement('div');
      const size = rand(52, 96);     // bigger for clearer look
      const left = rand(6, 88);      // %
      const top  = rand(14, 70);     // %

      m.className = 'marble';
      m.style.width = `${size}px`;
      m.style.height = `${size}px`;
      m.style.left = `${left}%`;
      m.style.top  = `${top}%`;
      m.style.setProperty('--r', Math.random().toFixed(3));

      const img = document.createElement('img');
      img.loading = 'lazy';
      img.alt = g.identity?.name || 'Steam game';
      img.src = g.media.header_image;

      m.appendChild(img);
      wrap.appendChild(m);
    });
  }

  function renderGame(ballEl, game){
    const body = ballEl.querySelector('.ball-body');
    const price = (game?.pricing?.is_free)
      ? 'Free'
      : (typeof game?.pricing?.price_usd === 'number'
          ? `$${game.pricing.price_usd.toFixed(2)}`
          : '—');

    const pub = (game?.identity?.publishers || []).join(', ') || '—';
    const dev = (game?.identity?.developers || []).join(', ') || '—';
    const tags = (game?.classification?.tags || []).slice(0, 16);

    const appid = game?.app_id;
    const name  = game?.identity?.name || 'Unknown Game';
    const capsule = game?.media?.header_image || '';
    const link = appid ? `https://store.steampowered.com/app/${appid}/` : '#';

    body.innerHTML = `
      <div class="result-card">
        ${capsule ? `<img class="thumb" src="${capsule}" alt="${name}">` : ''}
        <div class="card-head">
          <div class="title-block">
            <h2 class="title">
              <a class="title-link" href="${link}" target="_blank" rel="noopener noreferrer">${name}<span class="ext">↗</span></a>
            </h2>
            <div class="sub-links">
              <span class="appid">AppID: ${appid ?? '—'}</span>
              <span class="dot">•</span>
              <span>Price: ${price}</span>
            </div>
          </div>

          <div class="meta-grid">
            <div><span class="k">Developers</span><span class="v">${dev}</span></div>
            <div><span class="k">Publishers</span><span class="v">${pub}</span></div>
          </div>

          ${tags.length ? `<div class="tags">${tags.map(t=>`<span class="tag">${t}</span>`).join('')}</div>` : ''}
        </div>
      </div>
    `;

    applyCapColor(ballEl);
    layoutBall(ballEl);
  }

  // JSONL loader
  async function loadJSONL(url){
    const txt = await fetch(url, {cache:'no-store'}).then(r=>r.text());
    const lines = txt.split(/\r?\n/).filter(Boolean);
    const out = [];
    for (const line of lines) {
      try { out.push(JSON.parse(line)); } catch(e) { /* ignore bad line */ }
    }
    return out;
  }

  // ---------------- Boot ----------------
  const btnLoad = document.getElementById('btnLoad');
  const btnRoll = document.getElementById('btnRoll');
  const ball = document.getElementById('ball');
  const metaEl = document.getElementById('resultsMeta');

  const $q = $('#q'), $min = $('#priceMin'), $max = $('#priceMax'), $dateMin = $('#dateMin'), $hideUn = $('#hideUnreleased');
  $('#apply').addEventListener('click', ()=> updateMeta());
  $('#clear').addEventListener('click', ()=>{
    $q.value=''; $min.value=''; $max.value=''; $dateMin.value=''; $hideUn.checked=false; updateMeta();
  });

  function updateMeta(){
    const f = getFilters();
    const n = filterGames(GAMES, f).length;
    metaEl.textContent = GAMES.length ? `Matching games: ${n} / ${GAMES.length}` : '';
  }

  let GAMES = [];

  function chooseRandomGameFiltered(){
    const f = getFilters();
    const pool = filterGames(GAMES, f);
    if (!pool.length) return null;
    return pool[Math.floor(Math.random()*pool.length)];
  }

  // keep layout snug on resize
  window.addEventListener('resize', () => layoutBall(ball));

  btnLoad.addEventListener('click', async ()=>{
    btnLoad.disabled = true;
    btnLoad.textContent = 'Loading…';
    try {
      GAMES = await loadJSONL('games.jsonl');
      buildBowlMarbles(GAMES);
      btnRoll.disabled = false;
      btnLoad.textContent = 'Loaded';
      ball.classList.add('drop','open');
      updateMeta();
      const g = chooseRandomGameFiltered() || GAMES[0];
      if (g) renderGame(ball, g);
    } catch(e){
      console.error(e);
      btnLoad.textContent = 'Error';
    }
  });

  btnRoll.addEventListener('click', ()=>{
    if (!GAMES.length) return;
    btnRoll.classList.remove('spin'); void btnRoll.offsetWidth; btnRoll.classList.add('spin');
    const g = chooseRandomGameFiltered() || null;
    if (g) renderGame(ball, g);
    updateMeta();
  });
  </script>
</body>
</html>
